# Story 4.6: 按日期统计功能

## Story

**As a** 系统管理员  
**I want** 能够按日期统计出力数据  
**so that** 我可以了解出力数据的时间分布和趋势，识别业务高峰和低谷，进行有效的资源规划。

## Status

Ready for Development

## Context

按日期进行统计是出力数据分析的基础维度，也是了解业务时间模式的关键。通过这种方式，管理员可以了解不同时间段的出力量变化，识别业务的季节性和周期性，发现异常波动，为人力调配和业务预测提供数据支持。

本故事将实现按日期统计的功能，包括数据表格展示和时间序列图表，允许用户通过店铺类别、具体店铺、快递类型等筛选条件进一步细化分析。该功能是统计分析功能（Epic 4）的重要组成部分，依赖于统计分析页面基础 UI（故事 4.1）和统计维度选择功能（故事 4.2）。

## Estimation

Story Points: 3

## Acceptance Criteria

1. - [ ] 当用户选择"按日期统计"维度时，显示相应的统计数据
2. - [ ] 使用数据表格展示各日期的统计结果，包含以下列：
   - 日期
   - 当日总出力量
   - 环比变化（与前一日相比）
   - 同比变化（与去年同一日相比，如果有数据）
   - 活跃店铺数量
   - 快递类型分布
3. - [ ] 使用图表直观展示时间序列数据：
   - 提供折线图显示一段时间内的出力量变化
   - 提供柱状图显示各日期的出力量大小
   - 提供堆叠柱状图显示各日期不同店铺类别或快递类型的出力分布
   - 图表支持切换不同的显示方式和分组方式
4. - [ ] 支持以下筛选条件：
   - 日期范围（必选）
   - 店铺类别（可选，多选）
   - 店铺（可选，多选）
   - 快递类型（可选，多选）
5. - [ ] 支持表格数据排序，可以按日期或出力量排序
6. - [ ] 支持表格分页，当日期范围较大时分页显示
7. - [ ] 支持数据粒度选择，如按日、按周、按月汇总显示
8. - [ ] 点击某一日期时，可以查看该日的详细统计信息
9. - [ ] 图表支持交互，悬停时显示详细数据
10. - [ ] 支持显示移动平均线，帮助识别长期趋势
11. - [ ] 可选择显示同期对比数据，便于同比分析
12. - [ ] 数据加载过程中显示适当的加载状态

## Subtasks

1. - [ ] 实现数据获取服务
   1. - [ ] 在 `lib/api/stats.ts` 中添加获取按日期统计数据的方法
   2. - [ ] 实现日期范围、店铺类别、店铺和快递类型筛选参数
   3. - [ ] 实现不同粒度（日、周、月）的数据聚合逻辑
   4. - [ ] 处理数据加载状态和错误情况
2. - [ ] 实现数据表格组件
   1. - [ ] 创建 `app/stats/components/DateStatsTable.tsx` 组件
   2. - [ ] 实现表格列配置和数据绑定
   3. - [ ] 添加排序功能
   4. - [ ] 实现分页控件
   5. - [ ] 添加日期点击交互
3. - [ ] 实现数据可视化图表
   1. - [ ] 创建 `app/stats/components/DateStatsChart.tsx` 组件
   2. - [ ] 集成 Recharts 或其他图表库
   3. - [ ] 实现折线图、柱状图和堆叠柱状图
   4. - [ ] 添加图表切换功能和分组选项
   5. - [ ] 实现移动平均线功能
   6. - [ ] 实现同期对比功能
   7. - [ ] 实现图表交互和工具提示
4. - [ ] 实现日期详情视图
   1. - [ ] 创建 `app/stats/components/DateDetailModal.tsx` 组件
   2. - [ ] 实现详情数据获取和展示
   3. - [ ] 添加详情图表和表格
5. - [ ] 实现数据粒度选择功能
   1. - [ ] 添加粒度选择控件（日、周、月）
   2. - [ ] 实现数据粒度切换逻辑
   3. - [ ] 确保图表和表格正确响应粒度变化
6. - [ ] 完善筛选器组件
   1. - [ ] 更新 `StatsFilterPanel.tsx` 组件以支持日期统计所需的筛选条件
   2. - [ ] 实现店铺类别多选框
   3. - [ ] 实现店铺多选框
   4. - [ ] 实现快递类型多选框
   5. - [ ] 添加筛选条件重置功能
7. - [ ] 集成到统计分析页面
   1. - [ ] 在 `ShopOutputStats.tsx` 中条件性渲染日期统计组件
   2. - [ ] 连接维度选择、筛选器和数据展示组件
   3. - [ ] 优化页面布局和交互流程
8. - [ ] 性能优化
   1. - [ ] 实现数据缓存机制
   2. - [ ] 优化大数据量下的渲染性能
   3. - [ ] 实现数据预聚合

## Testing Requirements:

- 单元测试覆盖率 >= 85%
- 对数据表格和图表组件进行组件测试，验证渲染和交互逻辑
- 测试筛选功能，验证筛选条件对数据结果的影响
- 测试不同数据粒度的聚合逻辑
- 测试移动平均线和同期对比功能
- 测试排序和分页功能
- 测试日期详情查看功能
- 测试大数据量下的性能和响应速度
- 测试与 API 的集成，包括不同参数组合的情况
- 进行端到端测试，验证整个功能流程

## Notes

- 使用 shadcn/ui 的 Table 组件实现数据表格
- 使用 Recharts 实现数据可视化图表
- 使用 shadcn/ui 的 Dialog 组件实现日期详情模态框
- 使用 shadcn/ui 的 Select 或 ToggleGroup 组件实现粒度选择
- 折线图中使用虚线或不同颜色表示移动平均线和同期对比数据
- 环比和同比变化应使用颜色指示增长（绿色）或下降（红色）
- 考虑在图表中标记重要日期或节假日，提高数据解读价值
- 确保图表的时间轴清晰易读，特别是在不同粒度下
- 参考现有的统计分析页面样式，确保视觉一致性
